# Поиск дешёвых авиабилетов по Европе с проверкой «ниже средней цены за год»

Этот проект ищет самые дешёвые авиабилеты по Европе через **официальные API** (без парсинга сайтов),
сравнивает найденные текущие цены с 365‑дневной средней ценой по каждому направлению (маршрут `IATA_FROM → IATA_TO`)
и на запрос выводит таблицу направлений, где текущая цена **ниже средней** на заданный порог.

## Что умеет
- Подключения к нескольким провайдерам (сейчас: Amadeus, Kiwi Tequila). Легко расширяется.
- Сканирование дат вылета на горизонте N дней вперёд; фильтр по стыковкам и багажу.
- Сохранение результатов в SQLite (`data/flight_deals.sqlite`).
- Автоматический расчёт средней цены за 365 дней по каждому направлению.
- Выгрузка таблицы «сделок» — где текущая цена ниже средней на X% (например, −20%).

> ⚠️ Для работы нужны API‑ключи. Парсинг «всех известных сайтов» нарушает правила многих площадок,
поэтому используется только официальная API‑доступность.

## Быстрый старт

1. Установите зависимости
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

2. Создайте `.env` по образцу
```bash
cp .env.example .env
# заполните ключи AMADEUS и TEQUILA
```

3. Подготовьте список аэропортов (IATA) Европы: замените `airports_eu_sample.csv` на свой (или используйте готовый).
Формат: `IATA,COUNTRY,CITY`

4. Заполните историю/средние (по желанию)
   - Можно просто накопить историю ежедневным запуском `scan`.
   - Или импортировать свои исторические данные в таблицу `prices` (см. схему в `storage.py`).

5. Сканируйте ближайшие даты (пример для RIX → вся Европа, 30 дней вперёд, без пересадок):
```bash
python -m src.cli scan --origins RIX --destinations-from-csv airports_eu_sample.csv --days-ahead 30 --max-stops 0
```

6. Покажите «сделки» — текущие цены ниже средней на X% (например, −20%):
```bash
python -m src.cli deals --threshold -20 --limit 50
```

7. (Опционально) Телеграм‑бот:
- Заполните `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID` в `.env`
- Запустите:
```bash
python -m src.telegram_bot
```
Команда в чате: `/deals -20 50` (порог и лимит).

## Как это работает

- `providers/*` — модули провайдеров. Каждый возвращает список предложений по заданным параметрам
  (дата, маршрут, класс, багаж и пр.).
- `storage.py` — SQLite c таблицей `prices` для истории. Вставка/апсерт цен, расчёт 365‑дневной средней.
- `aggregator.py` — объединяет результаты от провайдеров, унифицирует валюту/поля.
- `cli.py` — команды:
  - `scan` — проходит по комбинациям направлений и дат, записывает цены в БД.
  - `deals` — выбирает из БД предложения «сейчас ниже средней» (с учётом порога), печатает таблицу и сохраняет CSV.
- `main.py` — пример использования из кода (импорт функций).

## Ограничения и примечания
- Нужны валидные API‑ключи и тарифы с доступом к поиску.
- Историческая средняя формируется из ваших накопленных записей (или импорта). Чем больше истории — тем точнее средние.
- Валюта по умолчанию — EUR. Можно поменять в `.env`.
- Лёгкая «мок‑режим» проверка: если ключи не заданы, провайдеры сгенерируют тестовые данные.

## Лицензия
MIT
